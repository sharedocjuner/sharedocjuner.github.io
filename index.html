<!doctype html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />

    <title>ë„˜ì¹˜ì§€ë„, ë¶€ì¡±í•˜ì§€ë„ ì•ŠëŠ” kubernetes ë‹¤ë£¨ê¸°</title>

    <meta name="description" content="ë„˜ì¹˜ì§€ë„, ë¶€ì¡±í•˜ì§€ë„ ì•ŠëŠ” kubernetes ë‹¤ë£¨ê¸°" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="stylesheet" href="assets/3rdparty/reveal.js/css/reveal.css" />
    <link rel="stylesheet" href="assets/3rdparty/reveal.js/css/theme/simple.css" id="theme" />

    <link rel="stylesheet" href="assets/markdeck/styles/zenburn.css" />

        <link rel="stylesheet" href="assets/markdeck/css/markdeck.revealjs.css" />
    <link rel="stylesheet" href="assets/css/slides.css" />

    <script>
        window.pdf_render = window.location.search.match(/render=pdf/gi) != null;
        if (window.pdf_render) {
            document.write('<link rel="stylesheet" href="assets/css/render-pdf.css" type="text/css">');
        }
    </script>

    <link href="assets/css/rerendering.css" rel="stylesheet"></link>


</head>
<body>


    <div class="rerendering-message"><h1>R E R E N D E R I N G</h1></div>
    <div class="markdeck-logo"><a href="https://github.com/arnehilmann/markdeck">powered by markdeck</a></div>

    <div class="reveal">
        <div class="slides">

<section id="ë„˜ì¹˜ì§€ë„-ë¶€ì¡±í•˜ì§€ë„-ì•ŠëŠ”-kubernetes-ë‹¤ë£¨ê¸°" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>ë„˜ì¹˜ì§€ë„, ë¶€ì¡±í•˜ì§€ë„ ì•ŠëŠ” kubernetes ë‹¤ë£¨ê¸°</h1>
<p>ë‹¹ì‹ ì´ ëª¨ë¥´ë©´ ë‹¹í•˜ëŠ” 3ê°€ì§€ ì¥ì• </br>
Kubernetesì˜ Secret Recipe</br>
</span></p>
</section>
<section id="hello-i-am" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Hello! I am</h1>
<p><strong>Junho.son</strong> </br>
<small> junho.son@linecorp.com</small> </br>
Work at <span style="color: green;"><strong>Line</strong></span> </br>
Dev, Ops, All about the Nucleo. </br>
<img src="./assets/images/itsme.jpg" width="240" height="420"></p>
</section>
<section id="first-met-with-kubernetes." class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>First met with Kubernetes.</h1>
<p>ìˆœí’ì— ë— ë‹¨ë“¯ ì˜ ë‚˜ê°€ë˜ kubernetes </br>
<img src="./assets/images/yougetk8s.jpg" width="400" height="350"></p>
</section>
<section id="but-some-while" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>But, Some whileâ€¦</h1>
<p><img src="./assets/images/start.jpg" width="350" height="350"></p>
</section>
<section id="objectitive" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Objectitive</h1>
<section id="section" class="level2">
<h2></h2>
<p><span style="font-family: xkcd Script; font-size: 1.5em;">
incidents teach you</br>
how to build a <span style="color: yellow">reliable system</span></br>
</span>
</br></p>
<p>ì œê°€ ê²ªì—ˆë˜ ë“±ì— ë•€ë‚˜ëŠ” ìƒí™©ì„ ì—¬ëŸ¬ë¶„ë“¤ì´ ê²ªì§€ì•Šê³ ,</br><br />
ë¯¸ë¦¬ ëŒ€ì‘í•  ìˆ˜ ìˆë„ë¡ ê³µìœ í•˜ëŠ” ìë¦¬ì…ë‹ˆë‹¤.</br></p>
<p>ë§Œì•½ ì—¬ëŸ¬ë¶„ë“¤ì´ ëª¨ë‘ ê²ªì€ ì¼ì´ë¼ë©´â€¦</br>
</span></p>
</section>
<section id="section-1" class="level2">
<h2></h2>
<p><img src="./assets/images/thumbs-up-rambo.jpg" width="400" height="350"></p>
<p>ì•„ì£¼ ì¢‹ì€ í´ëŸ¬ìŠ¤í„°ë¥¼ ê°€ì§€ê³  ê³„ì‹œêµ°ìš”â€¦<img src="assets/markdeck/emojis/1f44d.png" alt="ğŸ‘" class="emoji" /></p>
</section>
</section>
<section id="index" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Index</h1>
<p>ì˜¤ëŠ˜ì€ ì´ì•¼ê¸° í•˜ê³  ì‹¶ì€ ê²ƒë“¤: </br></p>
<ul>
<li>ëª¨ë¥´ë©´ ë¬´ì¡°ê±´ ë‹¹í•˜ëŠ” kubernetes ì¥ì• <br />
</li>
<li>ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” kubernetesë¥¼ ë§Œë“¤ê¸°<br />
</li>
<li>ìš´ì˜ ìë™í™”ë¥¼ ìœ„í•œ ë‹¤ìŒ ê³„íš</li>
</ul>
</section>
<section id="first-talk-about" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>First, Talk about:</h1>
<ul>
<li>ETCD mvcc: database space exceeded </br></li>
<li>Invalid master/kubelet certification </br></li>
<li>Slow scheduling and DNS failure </br></li>
</ul>
</section>
<section id="etcd-database-space-exceeded" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>ETCD database space exceeded</h1>
<section id="section-2" class="level2">
<h2></h2>
<p>ì˜ ë™ì‘í•˜ë˜ <span style="color:yellow;">kubernetes</span> ì—ì„œ ì•„ë˜ì˜ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.<img src="assets/markdeck/emojis/1f62d.png" alt="ğŸ˜­" class="emoji" /></p>
<pre><code>$ kc apply -f deployment/app.yaml
etcdserver: mvcc: database space exceeded

$ kc scale --current-replicas=2 --replicas=3 deployment/nucleo-flask-sample -n junho-son
etcdserver: mvcc: database space exceeded</code></pre>
</section>
<section id="section-3" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>ì¦ìƒ</em></br></span></p>
<small>
<li>
ETCD read only</br>
</li>
<li>
k8s objectë“¤ì˜ update(ë³€ê²½, ìƒì„± ë“±)ì´ ë¶ˆê°€ëŠ¥í•´ì§</br>
</li>
<p></small></p>
<p><span style="color:skyblue;"><em>ì›ì¸</em></br></span></p>
<small>
<li>
ETCD keyspaceëŠ” key/valueì™€ í•¨ê»˜ ê·¸ê²ƒì˜ <strong>revision history</strong>ë¥¼ ì €ì¥í•œë‹¤.</br>
</li>
<li>
<span style="color:yellow;"> hisotryê°€ ì¦ê°€í•¨</span> -&gt; crd, deploymentì˜ ë¹ˆë²ˆí•œ ë³€ê²½</br>
</li>
<li>
ì„±ëŠ¥ ì €í•˜ ë° ì €ì¥ê³µê°„ ê³ ê°ˆì„ í”¼í•˜ê¸° ìœ„í•´ ì£¼ê¸°ì ì¸ <strong>compactionê³¼ defragment</strong>ì´ í•„ìš”</br>
</li>
<p></small></p>
</section>
<section id="section-4" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Solutions</em></span></p>
<ul>
<li>step1. etcdctlë¡œ compactionê³¼ defragmentë¥¼ í•¨</li>
</ul>
<pre><code>export PEERS=&quot;http://10.127.111.53:2379,http://10.127.114.99:2379,http://10.127.114.96:2379&quot;
export ETCDCTL_API=3 

# compaction
$ rev=$(etcdctl  endpoint status --write-out=&quot;json&quot; | egrep -o &#39;&quot;revision&quot;:[0-9]*&#39; | egrep -o &#39;[0-9]*&#39;)
$ etcdctl compact $rev
compacted revision 518729

# size ì•ˆ ì¤„ì—ˆìŒ
| http://10.127.111.53:2379 | 750655cd04e8a0f0 | 3.2.15 | 2.1 GB | false | 4 | 578868 |
| http://10.127.114.99:2379 | 77c94c09da32ea5a | 3.2.15 | 2.2 GB | true | 4 | 578868 |
| http://10.127.114.96:2379 | 7fa913847ab8f9f5 | 3.2.15 | 2.1 GB | false | 4 | 578868 |

# defragment(resize high watermark)
$ etcdctl --endpoints ${PEERS} defrag
Finished defragmenting etcd member[http://10.127.111.53:2379]
Finished defragmenting etcd member[http://10.127.114.99:2379]
Finished defragmenting etcd member[http://10.127.114.96:2379]

# size ì¤„ì—ˆìŒ
| http://10.127.111.53:2379 | 750655cd04e8a0f0 | 3.2.15 | 9.7 MB | false | 4 | 582117 |
| http://10.127.114.99:2379 | 77c94c09da32ea5a | 3.2.15 | 9.7 MB | true | 4 | 582117 |
| http://10.127.114.96:2379 | 7fa913847ab8f9f5 | 3.2.15 | 9.7 MB | false | 4 | 582117 |</code></pre>
</section>
<section id="section-5" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Solutions</em></span></p>
<ul>
<li>step2. etcdctlë¡œ alarm disarmì„ í•´ì•¼ í•¨</li>
</ul>
<pre><code>etcdctl --endpoints ${PEERS} alarm list
memberID:8631513766031452762 alarm:NOSPACE
memberID:8432521691336843504 alarm:NOSPACE

etcdctl --endpoints ${PEERS} alarm disarm
memberID:8631513766031452762 alarm:NOSPACE
memberID:8432521691336843504 alarm:NOSPACE</code></pre>
</section>
<section id="section-6" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>kube-apiserver compaction options(default: 5m)</p>
<pre><code>--etcd-compaction-interval duration     Default: 5m0s
The interval of compaction requests. \
If 0, the compaction request from apiserver is disabled.</code></pre>
</section>
<section id="section-7" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>scheduled defrag job</p>
<pre><code>#!/bin/bash
# start with random sleep
sleep $((RANDOM % 10 + 1))

CMD=$(which etcdctl)
ENDPOINT=$(cat /etc/etcd/etcd.conf  | grep &quot;ETCD_ADVERTISE_CLIENT_URLS&quot; | cut -d&quot;=&quot; -f2 | tr -d &quot;\&quot;&quot;)
LOG=&quot;/var/log/etcd-defrag-$(date +&quot;%Y%m%d&quot;)&quot;

ETCDCTL_API=3 ${CMD} --endpoints http://127.0.0.1:2379 \
  defrag --command-timeout=60s 1&gt;&gt;${LOG} 2&gt;&amp;1
ETCDCTL_API=3 ${CMD} --endpoints http://127.0.0.1:2379 \
  endpoint status 1&gt;&gt;${LOG}

# delete log
find /var/log/etcd-defrag-* -maxdepth 1 -type f -ctime +7 -delete</code></pre>
<p><small>Ref: <a href="https://www.ibm.com/support/knowledgecenter/en/SSBS6K_3.1.0/manage_cluster/manage_etcd_clusters.html" target="_blank">defrag using cronjob</a></small></p>
</section>
<section id="section-8" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>adjust etcd db size</p>
<pre><code>$ cat /etc/etcd/etcd.conf
...
ETCD_QUOTA_BACKEND_BYTES=&quot;4294967296&quot;
...</code></pre>
<pre><code>--quota-backend-bytes
    Raise alarms when backend size exceeds the given quota (0 defaults to low space quota).
    default: 0
    env variable: ETCD_QUOTA_BACKEND_BYTES</code></pre>
</section>
<section id="section-9" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>Monitoring</p>
<pre><code>Each etcd server exports metrics under the /metrics path on its client port and optionally on locations given by --listen-metrics-urls.
# prometheus scrap options
scrape_configs:
  - job_name: etcd
    static_configs:
    - targets: [&#39;10.127.157.129:2379&#39;,&#39;10.127.157.133:2379&#39;,&#39;10.127.157.137:2379&#39;]</code></pre>
<pre><code># prometheus query
etcd_debugging_mvcc_db_total_size_in_bytes 
etcd_debugging_mvcc_keys_total
etcd_debugging_mvcc_slow_watcher_total
...</code></pre>
<p><small><span style="color:white">Ref: <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/monitoring.md" target="_blank">prometheus scrap</a></span></small></p>
</section>
<section id="section-10" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>Backup</p>
<ul>
<li>etcd Backup</li>
</ul>
<pre><code>#!/bin/bash
BACKUP_DIR=&quot;/var/backup/etcd&quot;
ENDPOINT=http://127.0.0.1:2379
BACKUP_FILE=&quot;${BACKUP_DIR}/$(date +&#39;%y%m%d&#39;).db&quot;

mkdir -p ${BACKUP_DIR}
ETCDCTL_API=3 etcdctl --endpoints=${ENDPOINT} snapshot save &quot;${BACKUP_FILE}&quot;

cd ${BACKUP_DIR} &amp;&amp; etcdctl backup --data-dir /var/lib/etcd/default.etcd

sleep 1

# move member dir
mv ${BACKUP_DIR}/member ${BACKUP_DIR}/member-$(date +&#39;%y%m%d&#39;)

# cleanup backup older than 7 days
find /var/backup/etcd -maxdepth 1 -type f -ctime +7 -delete
find /var/backup/etcd/member-* -maxdepth 0 -type d -ctime +7 -exec rm -r /&quot;{}/&quot; \;</code></pre>
<p><small>Ref: <a href="https://juner417.github.io/blog/etcd-backup-and-restore/">backup and restore</a></small></p>
</section>
</section>
<section id="invalid-masterkubelet-certification" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Invalid master/kubelet certification</h1>
<section id="section-11" class="level2">
<h2></h2>
<p>ì–´ëŠë‚  ê°‘ìê¸° kubectlë¡œ ì¡°íšŒê°€ ë¶ˆê°€ëŠ¥ í•˜ê³ ,</p>
<p>nodeê°€ í•˜ë‚˜ ë‘˜ì”© NotReadyê°€ ë˜ê¸° ì‹œì‘í•œë‹¤.</p>
<p><img src="assets/markdeck/emojis/1f62d.png" alt="ğŸ˜­" class="emoji" /></p>
<pre><code>$ kc get pods
Unable to connect to the server: x509: certificate is valid 

# apiserver log 
E0709 10:55:24.437376       1 authentication.go:62] Unable to authenticate the request due to an error: \
  [x509: certificate has expired or is not yet valid, x509: certificate has expired or is not yet valid]</code></pre>
</section>
<section id="section-12" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>ì¦ìƒ</em></br></span></p>
<small>
<li>
kube-apiserver ì ‘ê·¼ ë¶ˆê°€ëŠ¥</br>
</li>
<li>
kubelet NotReady status</br>
</li>
<p></small></p>
<span style="color:skyblue;"><em>ì›ì¸</em></br></span>
<small>
<li>
master component/kubelet configì˜ ì¸ì¦ì„œ ë§Œë£Œ</br>
</li>
<li>
kubeadmì€ master component certëŠ” 1ë…„ì§œë¦¬ë¥¼ ë§Œë“¬</br>
</li>
<li>
kubeadm upgradeë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  upgradeë¥¼ í•¨(180ì¼ ë³´ë‹¤ ì‘ìœ¼ë©´ upgradeì‹œ ê°±ì‹ )</br>
</li>
<p></small></p>
</section>
<section id="section-13" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Solutions</em></span></p>
<p>kubeadm init phase certs [master component]</p>
<pre><code>## apiserver --cert-dirë¡œ ê¸°ì¡´ ca certë¡œ ìƒì„±í•´ì•¼ í•¨(ì•ˆí•˜ë©´ ìƒˆë¡­ê²Œ ca certìƒì„±)
kubeadm init phase certs all \
  --apiserver-advertise-address 10.20.192.31 \
  --apiserver-cert-extra-sans gonz-dev-caravan.devdev.com \
  --service-cidr 172.28.0.0/15 --cert-dir /root/test_pki/pki </code></pre>
<p>ìœ„ì—ì„œ ê°±ì‹ í•œ ë‚´ìš©ìœ¼ë¡œ kubelet admin.conf ë³€ê²½/ë°°í¬</p>
<pre><code>ansible-playbook -i inventory/service-dev/host renew_cert_node.yml</code></pre>
</section>
<section id="section-14" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>ë§˜í¸í•œê²Œ ì§±!
<em>master component certification</em>ì€,</p>
<ul>
<li>100ë…„ì§œë¦¬ certificationì„ ë§Œë“¤ì <img src="assets/markdeck/emojis/1f605.png" alt="ğŸ˜…" class="emoji" /> </br></li>
<li>kubeadmì„ ì´ìš©í•˜ì—¬ ìì£¼ upgradeë¥¼ í•˜ì(ê¶Œì¥).</br></li>
</ul>
<p>ê·¸ë ‡ë‹¤ë©´ <span style="color:yellow;">kubeletì€? <img src="assets/markdeck/emojis/1f914.png" alt="ğŸ¤”" class="emoji" /></span></p>
<p><small>
<a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/blob/master/docs/04-certificate-authority.md" target="_blank">certificate - kubernetes the hard way</a></br>
<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#automatic-certificate-renewal" target="_blank">upgrade using kubeadm</a></br>
</small></p>
</section>
<section id="section-15" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>kubelet rotate-certification ê¸°ëŠ¥ ì´ìš©</br></p>
<ul>
<li>kubeletì— <code>--rotate-certificates=true</code> ì˜µì…˜ ì¶”ê°€</li>
<li>kubelet feature-gatewayì— RotateKubeletServerCertificate=true</li>
<li>RotateKubeletServerCertificate v1.12ì—ì„œ Beta</li>
</ul>
<pre><code>$ cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
[Service]
...
Environment=&quot;KUBELET_CERTIFICATE_ARGS=--rotate-certificates=true --cert-dir=/var/lib/kubelet/pki&quot;
Environment=&quot;KUBELET_FEATURE_GATE_ARGS=--feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true&quot;</code></pre>
</section>
<section id="section-16" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>kubelet rotate-certification</p>
<pre><code>## ê³¼ì •ì€ ë§ë¡œ ì„¤ëª…... í•„ìš”?
ls -l /var/lib/kubelet/pki/
total 32
-rw------- 1 root root 1183 Jun 25 18:05 kubelet-client-2018-06-25-18-05-21.pem
-rw------- 1 root root 1183 Jun 25 18:46 kubelet-client-2018-06-25-18-46-17.pem
...
lrwxrwxrwx 1 root root   59 Jun 25 18:46 kubelet-client-current.pem -&gt; /var/lib/kubelet/pki/kubelet-client-2018-06-25-18-46-17.pem

# kubelet log
Jun 26 17:04:27 junho003-k8s-dev-jp2v-dev kubelet[12771]: I0626 17:04:27.206702   12771 transport.go:96] certificate rotation detected, shutting down client connections to start using new credentials

# kubelet config
$ cat /etc/kubernetes/kubelet.conf
...
users:
- name: default-auth
  user:
    client-certificate: /var/lib/kubelet/pki/kubelet-client-current.pem
    client-key: /var/lib/kubelet/pki/kubelet-client-current.pem</code></pre>
</section>
<section id="section-17" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>ì´ëŸ°ê±° ê´€ë¦¬í•˜ê¸° ë„ˆë¬´ í˜ë“¤ë‹¤â€¦</br>
kops(on aws), kubespray ì‚¬ìš©í•˜ì‹œë©´â€¦ </br>
í¸í• ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
</section>
</section>
<section id="slow-scheduling-and-dns-failure" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Slow scheduling and DNS failure</h1>
<section id="section-18" class="level2">
<h2></h2>
<p>large clusterë¥¼ ë§Œë“¤ê³ (node 1000),</br>
ì„œë¹„ìŠ¤ ë°°í¬(nginx - replica 5000)ì‹œ </br>
podì˜ <span style="color:yellow">scheduling</span>ì´ ë„ˆë¬´ ëŠë¦¬ë‹¤ </br>
ì„¸ì›”ì•„ ë„¤ì›”ì•„â€¦<img src="assets/markdeck/emojis/1f605.png" alt="ğŸ˜…" class="emoji" /> </br></p>
</section>
<section id="section-19" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>ì¦ìƒ</em></br></span></p>
<small>
<li>
1000ê°œ ë…¸ë“œì˜ í´ëŸ¬ìŠ¤í„°ì—ì„œ deployment ë°°í¬ì‹œ pod schedulingì´ ëŠë¦¬ë‹¤. </br>
</li>
<p></small></p>
<span style="color:skyblue;"><em>ì›ì¸</em></br></span>
<small>
<li>
podì´ schedulingë ë•Œ filteringê³¼ ranking(scoring)</br>
</li>
<li>
ëª¨ë“  ë…¸ë“œ(1000)ë¥¼ <span style="color:yellow;">filtering</span>í•˜ê³  <span style="color:yellow;">ranking</span>ì„ ê³„ì‚°í•˜ë‹¤ ë³´ë‹ˆ ì‹œê°„ì´ ì˜¤ë˜ê±¸ë¦¼</br>
</li>
<p></small></p>
<p><small>
Ref</br>
<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-scheduling/scheduler_algorithm.md" target="_black">scheduler algorithm</a></br>
<a href="https://medium.com/@dominik.tornow/the-kubernetes-scheduler-cd429abac02f" target="_black">scheduler details</a></br>
</small></p>
</section>
<section id="section-20" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Solutions</em></span></p>
<p>kube-schedulerì—ì„œ </br>
<span style="color:yellow;">percentageOfNodeToScore</span> ì˜µì…˜ ì¡°ì •</p>
<pre><code># cat schedulerconfig.yaml
...
percentageOfNodesToScore: 10
...</code></pre>
<aside class="notes">
ì´ ì˜µì…˜ì€ schedulerê°€ podì„ schedulingí• ë•Œ, ì „ì²´ë…¸ë“œê°€ ì•„ë‹Œ ì§€ì •í•œ ë…¸ë“œë§Œí¼ í™•ì¸ ë˜ë©´ ë…¸ë“œì˜ scoreë¥¼ ë§¤ê¸´ë‹¤.
</aside>
</section>
<section id="section-21" class="level2">
<h2></h2>
<p><img src="./assets/images/park.jpg" width="350" height="350"></p>
<p>ë­ìš”?</p>
</section>
<section id="section-22" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>k8s pod scheduling</p>
<p><img src="./assets/images/kube-scheduling.png" width="700" height="450"></p>
<p><small>
Ref: <a href="https://banzaicloud.com/blog/k8s-custom-scheduler/" target="_blank">k8s custom scheduler</a></br>
Ref: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-scheduling/scheduler.md" target="_blank">kubernetes scheduling</a></br>
</small></p>
<aside class="notes">
<ol type="1">
<li>podì˜ ìƒì„± ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´, podì˜ ì •ë³´ë¥¼ etcdì— ì €ì¥í•œë‹¤ ì´ë•Œ node name ì—†ë‹¤. </br></li>
<li>scheduler podë“¤ì„ watchí•˜ëŠ”ë°, nodeê°€ boundë˜ì§€ ì•ŠëŠ” podì„ í™•ì¸í•œë‹¤. </br></li>
<li>schedulerì—ì„œ ì í•©í•œ ë…¸ë“œë“¤ì„ filteringí•˜ê³ , scoreë¥¼ ë§¤ê²¨ podì— ì í•©í•œ nodeë“¤ì´ ì ìˆ˜ë¥¼ ê³„ì‚°í•œë‹¤. </br></li>
<li>3ì—ì„œ ì°¾ì€ nodeë“¤ì„ apiserverì—ê²Œ ì•Œë ¤ì£¼ì–´ binding(etcdì— ì €ì¥)í•˜ê²Œ í•œë‹¤. </br></li>
<li>kubeletì€ apiserverë¥¼ í†µí•´ bound pod ì •ë³´ë¥¼ watchingí•˜ê³ , containerë¥¼ ì‹¤í–‰í•œë‹¤. </br></li>
</ol>
</aside>
</section>
<section id="section-23" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>Scheduler Performance Tuning</p>
<ul>
<li><span style="font-family: sans-serif;"> percentageOfNodesToScore - k8s v1.12ì— ì¶”ê°€ëœ ê¸°ëŠ¥ </span></li>
<li><span style="font-family: sans-serif;"> ì´ì „ì—ëŠ” ë¬´ì¡°ê±´ ëª¨ë“  ë…¸ë“œë¥¼ filtering, rankingí•¨</span>
<ul>
<li><span style="font-family: sans-serif;"> ëª¨ë“  ë…¸ë“œì˜ feasibiltyë¥¼ í™•ì¸í•˜ëŠ” - <span style="color:yellow">filtering</span> </span></li>
<li><span style="font-family: sans-serif;"> feasibilityê°€ ì¶©ì¡±í•œ ë…¸ë“œë“¤ì— ëŒ€í•´ì„œ scoreë¥¼ ë§¤ê¸°ëŠ” - <span style="color:yellow"> ranking</span> </span></li>
</ul></li>
</ul>
</section>
<section id="section-24" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Lessons Learned</em></span></p>
<p>Scheduler Performance Tuning</p>
<ul>
<li>percentageOfNodesToScoreë¥¼ ì ìš©í•˜ë©´, filteringì‹œ ëª¨ë“  ë…¸ë“œì˜ feasibilty ëŒ€ìƒìœ¼ë¡œ í•˜ì§€ ì•Šê³ ,</br></li>
<li>percentageOfNodesToScore(%)ê°¯ìˆ˜ë§Œí¼ filteringì´ ë˜ë©´, í•´ë‹¹ ë…¸ë“œë“¤ì„ ì ìˆ˜ë¥¼ ë§¤ê²¨ rankingí•œë‹¤</br></li>
</ul>
<p><small>
Ref: <a href="https://kubernetes.io/docs/concepts/configuration/scheduler-perf-tuning/" target="_blank">scheduler perf tuning</a>
</small></p>
</section>
<section id="section-25" class="level2">
<h2></h2>
<p>ê·¸ëŸ°ë° v1.14 ë¶€í„° </br>
ì´ í´ëŸ¬ìŠ¤í„° ì‚¬ì´ì¦ˆë¥¼ ì´ìš©í•˜ì—¬ ì´ ê°’ì„ ê³„ì‚°í•˜ëŠ” ê³µì‹ì´ ì¶”ê°€ ëë‹¤ í•˜ë„¤ìš”â€¦</br></p>
</section>
<section id="section-26" class="level2">
<h2></h2>
<p>ë‹¹ì‹ ì˜ DNSëŠ” ì•ˆë…•í•˜ì‹­ë‹ˆê¹Œ?</br></p>
<p>ë³´í†µ <code>dnsPolicy: clusterFirst</code> ì„¤ì •</br></p>
<p><small>
ë§Œì•½ dbë¥¼ ì‚¬ìš©í•˜ëŠ” java spring service ë“¤ì´ ë™ì‹œì— 100ê°œ ì´ìƒ ë°°í¬ëœë‹¤ë©´?</br>
-&gt; dns podë“¤ì´ ì£½ì–´ë‚˜ê°€ë©´ì„œ, service podë“¤ì´ CrashloopbackOffâ€¦</br>
-&gt; ë‚œ ë´¤ì–´â€¦ ê·¸ ì”ì¸í•œ ëª¨ìŠµì„â€¦ ì„œë¡œê°€ ì„œë¡œë¥¼ ì£½ì´ëŠ”â€¦ ê·¸ ëª¨ìŠµì€ ë§ˆì¹˜</br>
</small></p>
</section>
<section id="section-27" class="level2">
<h2></h2>
<p><img src="./assets/images/dogground.jpg" /></p>
</section>
<section id="section-28" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>ì¦ìƒ</em></br></span></p>
<small>
<li>
dnsë„ ì£½ê³ , service podë„ ì£½ê³  ìš°ë¦¬ ëª¨ë‘ ì£½ìâ€¦</br>
</li>
<p></small></p>
<span style="color:skyblue;"><em>ì›ì¸</em></br></span>
<small>
<li>
java processì—ì„œ ë™ì‹œì— kube-dnsì— ì¿¼ë¦¬í•¨</br>
</li>
<li>
5 dot ë¯¸ë§Œ(default)ì€ cache(dnsmasq) í•œë²ˆ ì¡°íšŒí•˜ê³  upstream host /etc/resolve.conf ì¡°íšŒ</br>
</li>
<li>
150ê°œì˜ java pod(sidecar 3)ì´ ë™ì‹œì— 5ê°œ pod kube-dns ì¿¼ë¦¬ </br>
</li>
<p></small></p>
</section>
<section id="section-29" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Solutions</em></span></p>
<p>ê±±ì •í•˜ì§€ ë§ˆì‹œê³  <span style="color:yellow;">cluster-proportional-autoscaler</span> í•œëŒ€ ë“¤ì´ì„¸ìš”â€¦ </br></p>
<p>ì•„ë‹ˆë©´, Pod <code>.spec.dnsConfig</code>ë¥¼ ì´ìš©í•˜ì—¬ ndots ì˜µì…˜ì„ ìˆ˜ì •</br></p>
</section>
<section id="section-30" class="level2">
<h2></h2>
<pre><code>...
    spec:
      containers:
      - command:
        - /cluster-proportional-autoscaler
        - --namespace=kube-system
        - --configmap=coredns-autoscaler     
        - --target=deployment/coredns         # ìì‹ ì˜ cluster dns target
        - --default-params={&quot;linear&quot;:{&quot;coresPerReplica&quot;:256,&quot;nodesPerReplica&quot;:16,&quot;preventSinglePointFailure&quot;:true}}
        - --logtostderr=true
        - --v=2
        image: k8s.gcr.io/cluster-proportional-autoscaler-amd64:1.2.0
...</code></pre>
<p><small>
Ref: <a href="https://github.com/kubernetes-incubator/cluster-proportional-autoscaler" target="_blank">cluster proportional autoscaler</a>
</small></p>
</section>
<section id="section-31" class="level2">
<h2></h2>
<p>default paramì˜ <span style="color:yellow;">coresPerReplica</span>, <span style="color:yellow;">nodesPerReplica</span> ê°’ìœ¼ë¡œ ì ì ˆí•œ podì˜ ê°œìˆ˜ë¥¼ ê³„ì‚°í•œ í›„</br>
dns deploy ê°’ì„ ì¡°ì •í•©ë‹ˆë‹¤.</br></p>
<pre><code>replicas = max( ceil( cores * 1/coresPerReplica ) ,
                ceil( nodes * 1/nodesPerReplica ) )</code></pre>
<p><small>
Ref: <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-horizontal-autoscaling/">cluster-proportional-autoscaler</a>
</small></p>
</section>
<section id="section-32" class="level2">
<h2></h2>
<p>ndots 3ê°œ ë¯¸ë§Œì´ë©´, upstream dnsë¥¼ ë³´ê²Œ ì¡°ì •(absoulute name)</p>
<pre><code>apiVersion: v1
kind: Pod
metadata:
  namespace: default
  name: example
spec:
  containers:
    - name: test
      image: nginx
  dnsConfig:
    options:
      - name: ndots
        value: &quot;3&quot;</code></pre>
<p><small>
Ref: <a href="https://pracucci.com/kubernetes-dns-resolution-ndots-options-and-why-it-may-affect-application-performances.html" target="_blank">ndots option affect your application performances</a>
</small></p>
</section>
</section>
<section id="ì‹ ë¢°í• ìˆ˜-ìˆëŠ”-kubernetesë¥¼-ë§Œë“¤ê¸°" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>ì‹ ë¢°í• ìˆ˜ ìˆëŠ” kubernetesë¥¼ ë§Œë“¤ê¸°</span></h1>
</section>
<section id="nginx-ingress-tunes" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Nginx ingress tunes </span></h1>
<section id="section-33" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>í•„ìš”ì„±</em></span></p>
<ul>
<li>ì‚¬ìš©ìê°€ local ë¨¸ì‹ (ë™ì¼ IP)ì—ì„œ ë¶€í•˜í…ŒìŠ¤íŠ¸ ì§„í–‰, íŠ¹ì •í•œ nginxë¡œ ë¦¬í€˜ìŠ¤íŠ¸ê°€ ëª°ë¦¬ê²Œ ëœë‹¤.</li>
<li>ì´ë•Œ íŠ¹ì •í•œ nginxëŠ” ì´ëŸ° trafficì„ backendë¡œ ë³´ë‚´ë‚˜ backendê°€ ì´ë¥¼ ì²˜ë¦¬í•˜ì§€ ëª»í•˜ê²Œ ë˜ë©´, ìˆœì‹ê°„ì— <span style="color:yellow">DDos</span> ê³µê²©ì²˜ëŸ¼ ë˜ì–´ ë²„ë¦¼</li>
<li>í•˜ë‚˜ì˜ ipì—ì„œ ë™ì‹œì— ë“¤ì–´ì˜¤ëŠ” ì»¤ë„¥ì…˜ ê°¯ìˆ˜ì˜ ì¡°ì •ì´ í•„ìš”.</li>
</ul>
<aside class="notes">
<ul>
<li>nginx-ingress controllerì˜ 503, 504 ë°œìƒ</li>
<li>í•´ë‹¹ threadì˜ processê°€ reloadë„ ì•ˆë¨.</li>
</ul>
</aside>
</section>
<section id="section-34" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>ì¦ìƒ</em></span></p>
<p><small>
ì‚¬ìš©ìê°€ 504 gateway timeout ì—ëŸ¬ í™•ì¸</br>
kibanaë¥¼ í™•ì¸í•´ ë³´ë‹ˆ 15:38~15:41ì‚¬ì´ì— ingress í•œ ì¥ë¹„ì—ì„œ 503(4000ê±´) 504(15ê±´) ë°œìƒ</br>
í•´ë‹¹ ì¥ë¹„ì— nginx í”„ë¡œì„¸ìŠ¤ í™•ì¸í•´ë³´ë‹ˆ ë‹¤ë¥¸í”„ë¡œì„¸ìŠ¤ì™€ ìƒì„±ì‹œê°„ì´ ë§ì´ ì°¨ì´ë‚˜ëŠ” í”„ë¡œì„¸ìŠ¤ í™•ì¸</br>
(reload í•˜ì§€ ëª»í•œ í”„ë¡œì„¸ìŠ¤ê°€ ìƒê¹€)
</small></p>
<pre><code>$ ps -ef | grep nginx
65534     10022 131013  0 15:37 ?        00:00:57 nginx: worker process &lt;-
65534     11562 131013  1 15:38 ?        00:01:43 nginx: worker process &lt;-
65534     62933 131013  0 17:41 ?        00:00:00 nginx: worker process
65534     62934 131013  0 17:41 ?        00:00:00 nginx: worker process
65534     62935 131013  0 17:41 ?        00:00:00 nginx: worker process

# í•´ë‹¹ í”„ë¡œì„¸ìŠ¤  SIGTERM(kill -15) ë¡œ ì£½ì¸ í›„ ìœ„ ì—ëŸ¬ ë°œìƒì•ˆí•¨</code></pre>
<p><small>
ë¡œê·¸ í™•ì¸í•´ ë³´ë‹ˆ ë¶€í•˜í…ŒìŠ¤íŠ¸ê°€ ìˆì—ˆê³ , backend podì€ hpaë¡œ í™•ì¥ ëìœ¼ë‚˜,</br>
nginxëŠ” ê·¸ ì´í›„ ì´ìƒ í”„ë¡œì„¸ìŠ¤ê°€ ë˜ê³  ì •ìƒ ë™ì‘ í•˜ì§€ ëª»í•¨
</small></p>
</section>
<section id="section-35" class="level2">
<h2></h2>
<p>ë™ì¼ ipë¡œ ë†’ì€ ë¶€í•˜ê°€ ì˜¤ëŠ” ìƒí™©(DDos)ì„ ë§‰ê¸° ìœ„í•œ nginx íŠœë‹
metadata.annotationì— ì•„ë˜ì˜ ê°’ ì¡°ì •</p>
<pre><code>nginx.ingress.kubernetes.io/limit-connections(ê°œìˆ˜) : 
  # í•˜ë‚˜ì˜ ipì—ì„œ í—ˆìš©ë˜ëŠ” ë™ì‹œ ì—°ê²° ê°œìˆ˜ -&gt; limit_conn
nginx.ingress.kubernetes.io/limit-rps(ê°œìˆ˜) : 
  # ë§¤ì´ˆë‹¹ ì£¼ì–´ì§„ ipì—ì„œ ë¶€í„° í—ˆìš©ë˜ëŠ” ì—°ê²°ì˜ ìˆ˜   -&gt; limit_req 
nginx.ingress.kubernetes.io/limit-rpm(ê°œìˆ˜) : 
  # ë§¤ë¶„ë‹¹ ì£¼ì–´ì§„ ipì—ì„œ ë¶€í„° í—ˆìš©ë˜ëŠ” ì—°ê²°ì˜ ìˆ˜  -&gt; limit_req</code></pre>
<ul>
<li><a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/annotations.md#rate-limiting">nginx ingress rate limiting</a></li>
</ul>
</section>
<section id="section-36" class="level2">
<h2></h2>
<pre><code>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
  ...
    &#39;nginx.ingress.kubernetes.io/limit-connections&#39; : &#39;300&#39;,
    &#39;nginx.ingress.kubernetes.io/limit-rpm&#39; : &#39;3500&#39;,
    &#39;nginx.ingress.kubernetes.io/limit-rps&#39; : &#39;500&#39;,
  ...</code></pre>
</section>
</section>
<section id="pod-qos" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Pod QoS</h1>
<section id="section-37" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>í•„ìš”ì„±</em></span></p>
<ul>
<li>k8sì— ì˜¬ë¼ê°„ appë“¤ì˜ reource ê²½í•©ì‹œ ì¤‘ìš”í•œ appì˜ oom ë°©ì§€</li>
</ul>
</section>
<section id="section-38" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>QoS ë¶„ë¥˜ ë° ì„¤ì •</em></span></p>
<ul>
<li>Podì€ 3ê°œì˜ QoS classë¥¼ ê°–ëŠ”ë‹¤.
<ul>
<li><span style="color:yellow;">Guaranteed</span> - limit/requestë¥¼ ëª¨ë‘ ë™ì¼í•œ ê°’ìœ¼ë¡œ ì¤€ ê²½ìš°,</li>
<li><span style="color:yellow;">Burstable</span> - requestëŠ” ì§€ì •ë˜ì–´ ìˆìœ¼ë‚˜ limitê°€ ì—†ëŠ”ê²½ìš°, í˜¹ì€ ê°™ì§€ê°€ ì•Šì€ ê²½ìš°, limitë¥¼ ì§€ì •ì•ˆí•˜ë©´ node capacityê°€ ì§€ì •ë¨</li>
<li><span style="color:yellow;">BestEffort</span> - request/limitê°€ ëª¨ë‘ ì§€ì • ì•ˆëœê²½ìš°</li>
</ul></li>
</ul>
</section>
<section id="section-39" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>Resource</em></span></p>
<ul>
<li><span style="color:yellow;">compressible</span>: cpuëŠ” ë¦¬ì†ŒìŠ¤ ë³´ì¥ì´ ì¶©ì¡±ë˜ì§€ ì•Šì„ ê²½ìš°, podì´ ì¢…ë£Œë˜ì§€ ì•ŠëŠ”ë‹¤. ì¼ì‹œì ìœ¼ë¡œ throttring ë  ë¿ì´ë‹¤.</li>
<li><span style="color:yellow;">incompressible</span>: memoryì€ ì••ì¶•í• ìˆ˜ ì—†ëŠ” ë¦¬ì†ŒìŠ¤ì´ê¸° ë•Œë¬¸ì— ë¶„ë¥˜ê°€ ìˆë‹¤.</li>
</ul>
</section>
<section id="section-40" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>ë™ì‘ë°©ì‹</em></span></p>
<p>kubernetesëŠ” QoS ë³„ë¡œ OOM_SCORE_ADJë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •í•˜ì—¬
linux oom kill ìš°ì„ ìˆœìœ„ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.</p>
<pre><code># ê°’ì´ 1000ì— ê°€ê¹Œìš¸ìˆ˜ë¡ oom kill ëŒ€ìƒ
-1000 &lt;= OOM_SCORE_ADJ &lt;= 1000</code></pre>
<p><small>
<a href="https://serverfault.com/questions/571319/how-is-kernel-oom-score-calculated">how is kernel oom score calculated</a>
</small></p>
</section>
<section id="section-41" class="level2">
<h2></h2>
<p><span style="color:skyblue;">BestEffort</span></p>
<pre><code>OOM_SCORE_ADJ: 1000</code></pre>
<ul>
<li>ë…¸ë“œì˜ ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•œ ê²½ìš° ì œì¼ ë¨¼ì € ì£½ìŒ lowest priority, ì´ ì»¨í…Œì´ë„ˆëŠ” ë…¸ë“œì˜ ì—¬ìœ  ë©”ëª¨ë¦¬ ë§Œ ì‚¬ìš©í• ìˆ˜ ìˆìŒ</li>
</ul>
</section>
<section id="section-42" class="level2">
<h2></h2>
<p><span style="color:skyblue;">Burstable</span></p>
<pre><code>2&lt;OOM_SCORE_ADJ&lt;999, 

min(max(2, 1000 - (1000 * memoryRequestBytes) / machineMemoryCapacityBytes), 999))</code></pre>
<ul>
<li>ìµœì†Œí•œì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ë³´ì¥í•œë‹¤. í•˜ì§€ë§Œ ê°€ëŠ¥í•˜ë‹¤ë©´ ë” ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í• ìˆ˜ ìˆìŠµë‹ˆë‹¤(limit - node capacity).</li>
<li>ì‹œìŠ¤í…œë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•  ê²½ìš°, ê·¸ë¦¬ê³  BestEffortê°€ ì—†ì„ ê²½ìš°, requestë¥¼ ë„˜ì–´ì„  ì‚¬ìš©ëŸ‰ì´ë©´ ì´ ì»¨í…Œì´ë„ˆê°€ ì£½ì„ ê²ƒì´ë‹¤.</li>
<li>í˜„ì œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ê³„ì‚°ë˜ëŠ” ë°©ì‹ì´ ë‹¤ë¦„.</li>
</ul>
</section>
<section id="section-43" class="level2">
<h2></h2>
<p><span style="color:skyblue;">Guaranteed</span></p>
<pre><code>OOM_SCORE_ADJ:-998</code></pre>
<ul>
<li>ìµœìš°ì„ ìˆœìœ„(top priority)ë¡œ ê°„ì£¼ë˜ë©° limitë¥¼ ì´ˆê³¼í•˜ì§€ ì „ê¹Œì§€ ì£½ì§€ ì•ŠëŠ”ë‹¤.</br></li>
</ul>
<p><strong>kubelet, dockerëŠ”</strong>
OOM_SCORE_ADJ; -999</p>
</section>
<section id="section-44" class="level2">
<h2></h2>
<p>OOM_SCORE_ADJ ê°’ì„ í™•ì¸í•˜ê³  ì‹¶ì„ë•ŒëŠ”â€¦</p>
<pre><code>docker inspect CONTAINERID | grep -i oom
cat /proc/PID/oom_score_adj</code></pre>
<ul>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md#qos-classes">resource QoS</a></li>
<li><a href="https://linux-mm.org/OOM_Killer">OOM_Killer</a></li>
<li><a href="http://blog.lastmind.io/archives/188">OOM killer and overcommit</a></li>
</ul>
</section>
</section>
<section id="etcd" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>ETCD</h1>
</section>
<section id="etcd-tuning" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>ETCD Tuning</h1>
<section id="diskë‚˜-networkìƒíƒœì—-ë”°ë¥¸-tune" class="level2">
<h2>Diskë‚˜ Networkìƒíƒœì— ë”°ë¥¸ Tune</h2>
</section>
<section id="section-45" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>í•„ìš”ì„±</em></span></p>
<p>SSD ì„œë²„ê°€ ì—†ë‹¤ë©´â€¦?</br>
ETCD ì´ì¤‘í™”ë¥¼ ìœ„í•´ ë…¸ë“œë¥¼ ë‹¤ë¥¸ zoneì— ë‘ê³  ì‹¶ë‹¤ë©´â€¦</br>
ì•„ë˜ì™€ ê°™ì€ warnì´ etcdì—ì„œ ìì£¼ ë°œìƒí•œë‹¤ë©´â€¦ </br></p>
<pre><code>2017-04-12 03:04:09.678778 W | etcdserver: \
failed to send out heartbeat on time \
(deadline exceeded for 185.938874ms)</code></pre>
<p>disk(SSDê¶Œì¥) <span style="color:yellow;">file I/O</span>ì™€ <span style="color:yellow;">network latency</span>ë¥¼ ê³ ë¯¼ </br>
<em>ë¬¼ë¦¬ì ì¸ êµì²´ê°€ ë‹¹ì¥ í˜ë“¤ë‹¤ë©´ etcd tuning</em></p>
</section>
<section id="section-46" class="level2">
<h2></h2>
<p>Letâ€™s get some tune</br></p>
<p><span style="color:yellow;">heartbeat interval</span> : leaderê°€ followì—ê²Œ ìì‹ ì˜ ë¦¬ë”ì„ì„ ì•Œë¦¬ëŠ” ì£¼ê¸°(default: 100ms)</br>
<span style="color:yellow;">election timeout</span> : followerê°€ leader ì„ ì¶œì„ í•˜ê¸° ì „ê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„(default: 1000ms)</br></p>
<ul>
<li>leaderëŠ” heartbeatì— metadataë¥¼ í•¨ê»˜ ì „ì†¡í•¨.</li>
</ul>
</section>
<section id="section-47" class="level2">
<h2></h2>
<p><span style="color:yellow;">heartbeat interval</span></p>
<p>ë„ˆë¬´ ì‘ìœ¼ë©´ ìì£¼ ë³´ë‚´ì„œ cpu/network resource ë§ì´ ì‚¬ìš©</br>
ë„ˆë¬´ í¬ë©´ leader failì„ ëŠ¦ê²Œ ê°ì§€</br></p>
<p><small>
Guide: memberë“¤ ê°„ í‰ê·  round-trip time(using ping) í‰ê· ì˜ max
</small></p>
<p><span style="color:yellow;">election timeout</span></p>
<p><small>
Guide: rrtì˜ ìµœì†Œ 10ë°° ì´ìƒ
</small></p>
</section>
<section id="section-48" class="level2">
<h2></h2>
<pre><code>$ cat /etc/etcd/etcd.conf
[member]
...
ETCD_HEARTBEAT_INTERVAL=&quot;500&quot;
ETCD_ELECTION_TIMEOUT=&quot;3000&quot;</code></pre>
</section>
<section id="section-49" class="level2">
<h2></h2>
<p>ë§Œì•½ diskì˜ metricì„ ë³´ë ¤ë©´â€¦</p>
<pre><code>## disk 
etcd_disk_wal_fsync_duration_seconds &lt; 10ms
etcd_disk_backend_commit_duration_seconds &lt; 25ms</code></pre>
</section>
</section>
<section id="service-lifecycle-ê´€ë¦¬" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Service Lifecycle ê´€ë¦¬</h1>
</section>
<section id="initial-delay" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Initial delay</h1>
<section id="section-50" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>í•„ìš”ì„±</em></span></p>
<p>server processì—ê²Œ ì‹œì‘í•  ì‹œê°„ì„ ì£¼ì </br></p>
</section>
<section id="section-51" class="level2">
<h2></h2>
<p>java spring processì˜ ê²½ìš° server portê°€ LISTEN ì´ì–´ë„</br>
server initializing í•˜ëŠ” ì‹œê°„ì´(DB ì ‘ì† ë“±) í•„ìš”í•˜ë‹¤.</br></p>
</section>
<section id="section-52" class="level2">
<h2></h2>
<pre><code>$ cat nucleo/app.yml
...
# Initial Delay Second(default: 30s)
# If you need to more than 30 sec to initialize your server process.
initial_delay: 60

# Health check path(default: /)
# if you don&#39;t want to send health checking request on root path(/).
# Important! App have to exist a path you specify.
health_path: /healthz</code></pre>
</section>
<section id="section-53" class="level2">
<h2></h2>
<pre><code>$ kc get pod \
 nucleo-flask-sample-371dac7-default-68f5674455-jnh6n -n junho-son -o yaml
...
    livenessProbe:
      failureThreshold: 3
      httpGet:
        path: /healthz
        port: 8080
        scheme: HTTP
      periodSeconds: 10
      initialDelaySeconds: 60
...</code></pre>
</section>
</section>
<section id="history-ê´€ë¦¬" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>History ê´€ë¦¬</h1>
<section id="section-54" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>í•„ìš”ì„±</em></span></p>
<ul>
<li>ì´ì „ ë²„ì „ replicaset, ì‹¤íŒ¨í•œ job pod, helm releaseë“± <span style="color:yellow;">history</span>ì„± ëª©ë¡ë“¤ì´ ë‚¨ì•„ìˆìŒ</li>
<li>ì•ˆì§€ìš°ë©´ etcd, api list ì‹œ ë¬¸ì œê°€ ìƒê¸´ë‹¤.</li>
</ul>
</section>
<section id="section-55" class="level2">
<h2></h2>
<ul>
<li>deployment</br></li>
</ul>
<pre><code>spec.revisionHistory</code></pre>
<ul>
<li>batchjob</br></li>
</ul>
<pre><code>spec.[activeDeadlineSeconds | backoffLimit]</code></pre>
<ul>
<li>cronjob</br></li>
</ul>
<pre><code>spec.[successfulJobsHistoryLimit(3) | failedJobsHistoryLimit(1)]</code></pre>
<ul>
<li>helm</br></li>
</ul>
<pre><code>helm init --history-max 10</code></pre>
</section>
<section id="section-56" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>ì ìš©</em></span></p>
<pre><code>## deploy revisionHistory
$ kc get deployment -n junho-son meister-f778746-default -o yaml
apiVersion: extensions/v1beta1
kind: Deployment
...
spec:
  progressDeadlineSeconds: 600
  replicas: 3
  revisionHistoryLimit: 3
...

## batch job
$ kc get job -n junho-son block-junho-son-mysql-dev-my-mysqldump-1547071200 -o yaml
apiVersion: batch/v1
kind: Job
...
spec:
  backoffLimit: 1

## install tiller
$ helm init --history-max 10</code></pre>
</section>
</section>
<section id="the-future-of-operating" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>The Future of Operating</h1>
<ul>
<li>operator sdk</li>
<li>kustomize + argo</li>
<li>cluster auto scaling</li>
<li>admin tools(app diagnostics)</li>
</ul>
</section>
<section id="q-a" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Q &amp; A</h1>
</section>
<section id="pod-priority-and-priorityclass" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Pod Priority and PriorityClass</h1>
<section id="section-57" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>í•„ìš”ì„±</em></span></p>
<ul>
<li>pod schedulingì‹œ ìƒëŒ€ì  ìš°ì„ ìˆœìœ„(weight)ë¥¼ ì§€ì •</li>
<li><p>ì¤‘ìš”í•œ ì„œë¹„ìŠ¤ì— ìš°ì„ ìˆœìœ„ë¥¼ ë§¤ê²¨, ë¨¼ì € ìŠ¤ì¼€ì¤„ë§ ë˜ê²Œ í•œë‹¤.</p></li>
<li>í´ëŸ¬ìŠ¤í„°ì— allocable resourceê°€ ë¶€ì¡±í•  ê²½ìš°,</li>
<li>ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ podì´ pendingì´ë¼ë©´, ë‚®ì€ìˆœìœ„ podì´ preemptionë¨</li>
<li><p>priorityclassë³„ Quota ì§€ì •ê°€ëŠ¥(v1.13 beta)</p></li>
</ul>
</section>
<section id="section-58" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>ë™ì‘ë°©ì‹</em></span></p>
<ul>
<li>podì„ ë…¸ë“œì— ìŠ¤ì¼€ì¤„ë§í• ë•Œ ì‚¬ìš©í•˜ëŠ” ìš°ì„ ìˆœìœ„(weight)</li>
<li>PriorityClass(1.14 stable)ë¡œ pod .specì— ì§€ì •</li>
<li>ìŠ¤ì¼€ì¤„ë§ ìˆœì„œ ì„ ì ê³¼ ë¦¬ì†ŒìŠ¤ ë¶€ì¡±ì‹œ preemption/evition ìˆœì„œì— ì˜í–¥ì„ ì¤€ë‹¤.</li>
<li>High priorityê°€ pendingë˜ê³  ìˆìœ¼ë©´, Low priorityëŠ” preemptionë  í™•ë¥ ì´ ë†’ë‹¤.</li>
<li>QoS objectì™€ ë…ë¦½ì ì´ê³ , namespaceì™€ ë³„ê°œ</li>
</ul>
</section>
<section id="section-59" class="level2">
<h2></h2>
<pre><code>$ kc get pc
NAME                      VALUE        GLOBAL-DEFAULT   AGE
system-cluster-critical   2000000000   false            135d
system-node-critical      2000001000   false            135d

$ kc get pod --all-namespaces -o \
  jsonpath=&#39;{range .items[*]}{.metadata.name}{&quot;\t&quot;}{.spec.priorityClassName}{&quot;\n&quot;}{end}&#39;
kube-apiserver-junho-devel001   system-cluster-critical
kube-apiserver-junho-devel002   system-cluster-critical
kube-apiserver-junho-devel003   system-cluster-critical</code></pre>
</section>
<section id="section-60" class="level2">
<h2></h2>
<p><span style="color:skyblue;">ë™ì‘ ë°©ì‹ - ìŠ¤ì¼€ì¤„ë§</span></p>
<ul>
<li>schedulerëŠ” pending podë“¤ì˜ priorityë¥¼ ê°€ì§€ê³  ìˆœì„œë¥¼ ì •í•œë‹¤.</li>
<li>ë†’ì€ ìš°ì„ ìˆœìœ„ì˜ podì´ ìŠ¤ì¼€ì¤„ë§ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ë©´ ë¨¼ì € ìŠ¤ì¼€ì¤„ë§ë¨</li>
<li>ë§Œì•½ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡± ëª»í•  ê²½ìš° preemptionì´ ë™ì‘í•˜ì—¬ ë‚®ì€ ìš°ì„ ìˆœìœ„ë¥¼ preemptioní•œë‹¤.</li>
<li>preemptionì„ í•´ë„ ë§Œì¡± ëª»í•˜ë©´ <em>ë‹¤ìŒ ìš°ì„ ìˆœìœ„ pod</em>ì´ ìŠ¤ì¼€ì¤„ë§ëœë‹¤.</li>
</ul>
</section>
<section id="section-61" class="level2">
<h2></h2>
<p><span style="color:skyblue;">íŠ¹ì§•</span></p>
<ul>
<li>namespaceì— ì œì•½ ë°›ì§€ ì•ŠëŠ” object.</li>
<li>name(.metadata.name)ìœ¼ë¡œë¶€í„° ìš°ì„ ìˆœìœ„ ì •ìˆ˜ ê°’(.value)ì„ priorityì— ë§¤í•‘í•˜ì—¬ ì •ì˜í•œë‹¤.(by admission controller)</li>
<li>pod specì— ì¡´ì¬ í•˜ì§€ ì•ŠëŠ” priorityclassê°€ ì§€ì •ë  ê²½ìš° reject(by admission controller)</li>
<li>system priority class(system-node-critical, cluster)ì€ kube-systemì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤. <a href="https://github.com/kubernetes/kubernetes/issues/78383">ì°¸ê³ </a></li>
</ul>
</section>
<section id="section-62" class="level2">
<h2></h2>
<pre><code>type PodSpec struct {
  ...
  PriorityClassName string
  Priority          *int32  // Populated by Admission Controller. Users are not allowed to set it directly.
}</code></pre>
</section>
<section id="section-63" class="level2">
<h2></h2>
<pre><code>type PriorityClass struct {
  metav1.TypeMeta
  // +optional
  metav1.ObjectMeta
  
  // The value of this priority class. This is the actual priority that pods
  // receive when they have the above name in their pod spec.
  Value        int32
  GlobalDefault     bool
  Description       string
}</code></pre>
</section>
<section id="section-64" class="level2">
<h2></h2>
<p><span style="color:skyblue;">í…ŒìŠ¤íŠ¸ </span></p>
<p>ëª©ì </br></p>
<ul>
<li>ì‚¬ìš©ì ì•±ì€ github repo ì´ë¦„ìœ¼ë¡œ namespaceê°€ ë‚˜ë‰˜ëŠ”ë°,</li>
<li>ê·¸ namespaceì— QoSë³„ ë‹¤ë¥¸ <span style="color:yellow;">priority quota</span>ë¥¼ ê°–ê²Œí•˜ì.</li>
</ul>
</section>
<section id="section-65" class="level2">
<h2></h2>
<p>priority class ìƒì„±</br></p>
<pre><code>$ kc get priorityclass
NAME                      VALUE        GLOBAL-DEFAULT   AGE
bustable                  1000         false            2s
guaranteed                900000000    false            2s
system-cluster-critical   2000000000   false            23d
system-node-critical      2000001000   false            23d</code></pre>
</section>
<section id="section-66" class="level2">
<h2></h2>
<p>Quota ìƒì„± ë° priorityclass ì§€ì •</br></p>
<pre><code>$ cat namespace-quota.yaml
---
apiVersion: v1
kind: Namespace
metadata:
  name: test-quota1
---
apiVersion: v1
kind: List
items:
- apiVersion: v1
  kind: ResourceQuota
  metadata:
    name: pods-guaranteed
    namespace: test-quota1
  spec:
    ...
    scopeSelector:
      matchExpressions:
      - operator : In
        scopeName: PriorityClass
        values: [&quot;guaranteed&quot;]
- apiVersion: v1
  kind: ResourceQuota
  metadata:
    name: pods-bustable
    namespace: test-quota1
  spec:
    ...
    scopeSelector:
      matchExpressions:
      - operator : In
        scopeName: PriorityClass
        values: [&quot;bustable&quot;]</code></pre>
</section>
<section id="section-67" class="level2">
<h2></h2>
<p>deployment ë°°í¬</p>
<pre><code># deployment for guaranteed
$ cat test-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment-on-guaranteed
  namespace: test-quota1
  labels:
    app: nginx
spec:
  replicas: 3
  ...
    spec:
      ...
      priorityClassName: guaranteed # priority ì§€ì •

# deployment for bustable
$ cat test-deployment-bustable.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment-on-bustable
  namespace: test-quota1
  labels:
    app: nginx2
spec:
  replicas: 3
    ...
    spec:
      ...
      priorityClassName: bustable  # priority ì§€ì •</code></pre>
</section>
<section id="section-68" class="level2">
<h2></h2>
<p>ë°°í¬</p>
<pre><code>$ kc create -f namespace-quota.yaml
$ kc create -f test-deployment-guaranteed.yaml
$ kc create -f test-deployment-bustable.yaml
$ kc describe quota -n test-quota1
Name:       pods-bustable
Namespace:  test-quota1
Resource    Used  Hard
--------    ----  ----
cpu         3     10
memory      3Gi   10Gi
#-&gt; bustable pod 3ê°œ ì¡í˜

Name:       pods-guaranteed
Namespace:  test-quota1
Resource    Used    Hard
--------    ----    ----
cpu         1500m   10
memory      1500Mi  10Gi
pods        3       20
#-&gt; guaranteed pod 3ê°œ ì¡í˜</code></pre>
</section>
<section id="section-69" class="level2">
<h2></h2>
<ul>
<li>Ref:</li>
<li><a href="https://juner417.github.io/blog/resourcequota-per-priority/" target="_blank">í…ŒìŠ¤íŠ¸ ìƒì„¸</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/scheduling/pod-priority-api.md#priority-classes" target="_blank">priority class design</a></li>
</ul>
</section>
</section>
<section id="prevent-node-failure-and-managing-resource" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Prevent Node Failure </br> and </br> Managing Resource</br></h1>
</section>
<section id="kubelet-gc" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Kubelet GC</h1>
<section id="section-70" class="level2">
<h2></h2>
<p>ì§€ê¸‹ì§€ê¸‹í•œ node diskê´€ë¦¬â€¦ ì´ì   GCë¡œ í•´ê²°</br></p>
<p><span style="color:skyblue;"><em>í•„ìš”ì„±</em></span></p>
<ul>
<li>Nodeì— resource ë¶€ì¡± ëŒ€ë¹„</li>
</ul>
<p><small>
Ref</br>
<a href="https://github.com/kubernetes/kubernetes/blob/v1.5.3/pkg/kubelet/images/image_gc_manager.go#L57" target="_blank">image collection</a></br>
<a href="https://github.com/kubernetes/kubernetes/blob/v1.5.3/pkg/kubelet/container/container_gc.go#L25" target="_blank">container collection</a></br>
</small></p>
</section>
<section id="section-71" class="level2">
<h2></h2>
<p>ë™ì‘ë°©ì‹</p>
<p><span style="color:skyblue;"><em>image collection</em></br></span></p>
<ul>
<li>ë§¤ 5ë¶„ ë§ˆë‹¤ ë™ì‘</li>
<li>HighThresholdPercent &gt;= disk usage ì‹¤í–‰</li>
<li>LowThresholdPercentê¹Œì§€ sizeê°€ ì¤„ë©´ ì¢…ë£Œ</li>
</ul>
<p><span style="color:skyblue;"><em>container collection</em></span></p>
<ul>
<li>ë§¤ 1ë¶„ ë§ˆë‹¤ ë™ì‘</li>
<li>minAgeë³´ë‹¤ ì˜¤ë˜ëœ (not running) containerë¥¼ ì œê±°</li>
<li>MaxPerPodContainer, MaxContainerê¹Œì§€ ë‚¨ê²¨ë‘ê³  ì •ë¦¬</li>
</ul>
</section>
<section id="section-72" class="level2">
<h2></h2>
<p>ì–´ë–»ê²Œ ì ìš©í–ˆë‚˜ - kubelet options</p>
<pre><code>apiVersion: kubelet.config.k8s.io/v1beta1
...
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 70
imageMinimumGCAge: 2m0s
maxContainer: -1
maxPerPodContainer: 1  # Crashloopbackoffì‹œ log -p ì˜µì…˜ì„ ìœ„í•œ ì„¤ì •
...</code></pre>
<p><small>
Ref: <a href="https://kubernetes.io/docs/concepts/cluster-administration/kubelet-garbage-collection/" target="_blank">kubelet GC</a>
</small></p>
</section>
<section id="section-73" class="level2">
<h2></h2>
<p>í•˜ì§€ë§Œ, ê³§ deprecated ëœë‹¤ê³  í•˜ë„¤ìš”â€¦<img src="assets/markdeck/emojis/1f622.png" alt="ğŸ˜¢" class="emoji" /></p>
<pre><code># ê¸°ì¡´ì˜ ì˜µì…˜ì´ ì‚¬ë¼ì§€ê³ , ì´ëŸ°ì‹ìœ¼ë¡œ... 
EvictionHard
  nodefs.available&lt;15%
EvictionSoft
  nodefs.available&lt;25%
  imagefs.available&lt;25%</code></pre>
<ul>
<li>ë” ìì„¸í•œê±´: <a href="https://stupefied-goodall-e282f7.netlify.com/contributors/design-proposals/node/kubelet-eviction/" target="_blank">evict options</a></li>
</ul>
</section>
</section>
<section id="graceful-eliminate" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Graceful eliminate </span></h1>
<section id="section-74" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>í•„ìš”ì„±</em></span></p>
<ul>
<li>ingress(nginx or haproxy)ë¥¼ í†µí•œ ì„œë¹„ìŠ¤ ì¸ì…êµ¬ì¡°</li>
<li>sh -c â€œcommandâ€ container cmdë¡œ server processê°€ SIG TERMì„ ëª»ë°›ìŒ
<ul>
<li>container terminationì€ pid 1ë¡œ SIG TERMë³´ëƒ„</li>
</ul></li>
<li>ì„œë²„ í”„ë¡œì„¸ìŠ¤ëŠ” graceperiod ì´í›„ SIG KILLë¡œ ì£½ìŒ</li>
</ul>
</section>
<section id="section-75" class="level2">
<h2></h2>
<ul>
<li>pod ì¢…ë£Œì‹œ pre_stop hookì„ ì´ìš©í•´ ë³¼ê¹Œ?</li>
</ul>
<p>ê·¼ë° ê·¸ëƒ¥ .spec.container.cmdë¥¼ ì„œë²„í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ëª…ë ¹ì–´ë¡œ ë°”ê¾¸ë©´ ì•ˆë¨?</br>
</br>
ë§ì•„ìš”â€¦ ê·¸ê²Œ ì œì¼ ê°„ë‹¨í•©ë‹ˆë‹¤.<img src="assets/markdeck/emojis/1f602.png" alt="ğŸ˜‚" class="emoji" /></br>
ê·¸ë¦¬ì„œ ìš°ë¦¬ë„ ê·¸ê±¸ë¡œ ë°”ê¾¸ë ¤ê³ ìš”.<img src="assets/markdeck/emojis/1f44d.png" alt="ğŸ‘" class="emoji" /></br></p>
</section>
</section>
<section id="reservce-resource-for-system" class="level1 light-on-dark" data-bg="#123456" data-background="#123456">
<h1>Reservce Resource for system</h1>
<section id="section-76" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>í•„ìš”ì„±</em></span></p>
<p>ì²˜ìŒì—” system ì˜ì—­ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ í™•ë³´í•˜ê³ ì í–ˆë‹¤. í•˜ì§€ë§Œâ€¦</p>
</section>
<section id="section-77" class="level2">
<h2></h2>
<p><span style="color:skyblue;"><em>ë™ì‘ë°©ì‹</em></span></p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="289" height="208" version="1.1">
    <defs>
        <filter id="dsFilterNoBlur" width="150%" height="150%">
            <feOffset dx="3" dy="3" in="SourceGraphic" result="offOut"/>
            <feColorMatrix in="offOut" result="matrixOut" type="matrix" values="0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"/>
            <feBlend in="SourceGraphic" in2="matrixOut" mode="normal"/>
        </filter>
        <filter id="dsFilter" width="150%" height="150%">
            <feOffset dx="3" dy="3" in="SourceGraphic" result="offOut"/>
            <feColorMatrix in="offOut" result="matrixOut" type="matrix" values="0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"/>
            <feGaussianBlur in="matrixOut" result="blurOut" stdDeviation="3"/>
            <feBlend in="SourceGraphic" in2="blurOut" mode="normal"/>
        </filter>
        <marker id="iPointer" fill="#000" markerHeight="7" markerUnits="strokeWidth" markerWidth="8" orient="auto" refX="5" refY="5" viewBox="0 0 10 10">
            <path d="M10 0v10L0 5z"/>
        </marker>
        <marker id="Pointer" fill="#000" markerHeight="7" markerUnits="strokeWidth" markerWidth="8" orient="auto" refX="5" refY="5" viewBox="0 0 10 10">
            <path d="M0 0l10 5-10 5z"/>
        </marker>
    </defs>
    <g id="text" fill="#000" font-family="Consolas,Monaco,Anonymous Pro,Anonymous,Bitstream Sans Mono,monospace" font-size="15.2">
        <text id="text0" x="-.9" y="28.8" fill="#000">
            Node A Capacity
        </text>
        <text id="text1" x="-.9" y="44.8" fill="#000">
            #-----------------------------#
        </text>
        <text id="text2" x="-.9" y="60.8" fill="#000">
            |
        </text>
        <text id="text3" x="17.1" y="60.8" fill="#000">
            kube-reserve |
        </text>
        <text id="text4" x="-.9" y="76.8" fill="#000">
            #-----------------------------#
        </text>
        <text id="text5" x="-.9" y="92.8" fill="#000">
            |
        </text>
        <text id="text6" x="17.1" y="92.8" fill="#000">
            system-reserve |
        </text>
        <text id="text7" x="-.9" y="108.8" fill="#000">
            #-----------------------------#
        </text>
        <text id="text8" x="-.9" y="124.8" fill="#000">
            |
        </text>
        <text id="text9" x="17.1" y="124.8" fill="#000">
            eviction-threshold |
        </text>
        <text id="text10" x="-.9" y="140.8" fill="#000">
            #-----------------------------#
        </text>
        <text id="text11" x="-.9" y="156.8" fill="#000">
            |
        </text>
        <text id="text12" x="17.1" y="156.8" fill="#000">
            allocatable |
        </text>
        <text id="text13" x="-.9" y="172.8" fill="#000">
            |
        </text>
        <text id="text14" x="17.1" y="172.8" fill="#000">
            (available for pods) |
        </text>
        <text id="text15" x="-.9" y="188.8" fill="#000">
            #-----------------------------#
        </text>
    </g>
</svg>
</p>
<p>Nodeì˜ capacityëŠ” ìœ„ ì²˜ëŸ¼ êµ¬ì„±</p>
<p><small>
* <span style="color:yellow;">kube-reserved</span>: kubelet, container runtime, npd</br>
* <span style="color:yellow;">system-reserved</span>: linux processes, sshd</br>
* <span style="color:yellow;">eviction-threshold</span>: ì•ì—ì„œ ì„¤ëª…í•œ</br>
* <span style="color:yellow;">allocatble</span>: nodeê°€ podì˜ ìŠ¤ì¼€ì¤„ë§ì„ ìœ„í•œ resource</br>
</small></p>
<p>2ê°œì˜ reservedì™€ thresholdë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ì „ì²´ ë…¸ë“œ ë¦¬ì†ŒìŠ¤ê°€ allocatable</p>
</section>
<section id="section-78" class="level2">
<h2></h2>
<p>ìš°ë¦¬ì˜ ì„¤ì •</p>
<pre><code>$ kc describe node [Nodename]
...
Allocatable:
cpu: 40
ephemeral-storage: 857955043546
hugepages-1Gi: 0
hugepages-2Mi: 0
memory: 65582228Ki
pods: 110
...

$ cat /var/lib/kubelet/config.yml
evictionHard:
imagefs.available: 15%
memory.available: 100Mi
nodefs.available: 10%
nodefs.inodesFree: 5%</code></pre>
<p>ì™œ? kube-reserved, system-reservedëŠ” í•˜ì§€ ì•Šì£ ?</p>
</section>
<section id="section-79" class="level2">
<h2></h2>
<p>í•˜â€¦ ê·¼ë° ì´ê²Œ ë¬¸ì œì¸ê²Œâ€¦</p>
<ul>
<li>kube-reserved, system-reservedë¥¼ ì§€ì •í•˜ë©´, í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ë“¤ì€ Bustableí•˜ì§€ ëª»í•¨ë‹ˆë‹¤.</li>
<li>ì˜¤íˆë ¤ ì„±ëŠ¥ì„ ì €í•˜ì‹œí‚¬ìˆ˜ ìˆì£ , ì˜ë¯¸ì—†ëŠ” evitionì´ ë°œìƒí• ìˆ˜ë„ ìˆê³ </li>
<li>ë§Œì•½ ì‚¬ìš©í•˜ê³  ì‹¶ìœ¼ì‹œë‹¤ë©´ ê¸°ì¡´ì˜ ì‚¬ìš©ëŸ‰ì„ ì˜ ëª¨ë‹ˆí„°ë§ í•´ì•¼ í•©ë‹ˆë‹¤.</li>
<li>ì–´ì°¨í”¼ kube,system-reservedëŠ” priorityë„ ë†’ê³ , oom_score_adjë„ ë‚®ìŠµë‹ˆë‹¤.</li>
<li>ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ ë˜ëŠ” pod ë³´ë‹¤, evition, oom killë  í™•ë¥ ì´ ë‚®ì£ .</li>
</ul>
<p><small>
link: <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.13/#nodestatus-v1-core">node v1 api doc</a></br>
link: <a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#eviction-policy">pod eviction</a></br>
link: <a href="https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/">reserve resource</a></br>
</small></p>
</section>
</section>

        </div>
    </div>

    <script src="assets/3rdparty/jquery.js"></script>

    <script src="assets/3rdparty/reveal.js/lib/js/head.min.js"></script>
    <script src="assets/3rdparty/reveal.js/js/reveal.js"></script>

    <script>
        // Full list of configuration options available here:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
            controls: 'true',
            controlsTutorial: '',
            controlsLayout: 'bottom-right',
            controlsBackArrows: 'faded',
            progress: 'true',
            defaultTiming: '120',
            slideNumber: 'true',
            history: 'true',
            keyboard: 'true',
            overview: 'true',
            center: 'true',
            touch: 'true',
            loop: '',
            rtl: '',
            shuffle: '',
            fragments: 'true',
            embedded: '',
            help: 'true',
            showNotes: '',
            autoPlayMedia: 'null',

            autoSlide: (window.pdf_render) ? 0 : 0,

            autoSlideStoppable: 'true',
            autoSlideMethod: 'Reveal.navigateNext',
            mouseWheel: '',
            hideAddressBar: 'true',
            previewLinks: '',
            transition: 'slide',
            transitionSpeed: 'default',
            backgroundTransition: 'fade',

            theme: 'simple',

            // Optional libraries used to extend on reveal.js
            dependencies: [
                { src: 'assets/3rdparty/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
                { src: 'assets/markdeck/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                { src: 'assets/3rdparty/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                { src: 'assets/3rdparty/reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
            ]
        });
    </script>

    
    <script src="assets/markdeck/revealjs-helper.js"></script>
    <script>
        flushleft(".slides .flushleft");
    </script>


</body>
</html>
